# 시스템 아키텍처

## 전체 흐름

```
[임직원]
   ↓ 메시지 전송
[네이버웍스 1:1 봇]
   ↓ Callback (Webhook)
[n8n 메인 워크플로우]
   ├─→ [대화 이력 조회]        ← Google Sheets (대화이력)
   ├─→ [FAQ 캐시 매칭]         ← Google Sheets (FAQ)
   │     ├─ 매칭됨 → 즉시 응답 (Gemini 호출 X)
   │     └─ 미매칭 ↓
   ├─→ [의도 분류 - Gemini]    → category, isAnswerable
   │     ├─ 답변 가능 ↓
   │     └─ 답변 불가 → 에스컬레이션 안내
   ├─→ [규정 조회]             ← Google Sheets (카테고리별 규정)
   ├─→ [응답 생성 - Gemini]    → 규정 기반 답변
   ├─→ [대화 이력 저장]        → Google Sheets (대화이력)
   └─→ [네이버웍스 응답 전송]
```

## 3-Tier 응답 전략

속도와 정확도를 동시에 잡기 위한 계층형 응답 구조.

| Tier | 조건 | 처리 방식 | 예상 응답 시간 |
|------|------|----------|--------------|
| **Tier 1** | FAQ 정확 매칭 | 사전 검증된 답변 즉시 반환 | ~1초 |
| **Tier 2** | FAQ 미매칭 + 답변 가능 | Gemini로 규정 기반 응답 생성 | ~3-5초 |
| **Tier 3** | 답변 불가 판단 | 담당자 정보 안내 (에스컬레이션) | ~2초 |

### Tier 1이 중요한 이유

- 임직원 문의의 60-70%는 반복 질문 (연차 며칠? 법인카드 한도? 출장비 정산 기한?)
- FAQ 매칭으로 Gemini 호출 없이 즉시 응답 → **비용 절감 + 속도 향상 + 정확도 보장**
- FAQ 답변은 경영지원 담당자가 직접 검수한 내용 → 할루시네이션 위험 0

## 속도 최적화 설계

### 1. FAQ 캐시 레이어 (Tier 1)
- Google Sheets에 자주 묻는 질문+답변 매핑 테이블 운영
- 키워드 기반 매칭으로 Gemini API 호출 자체를 스킵
- 매칭 로직: 사용자 메시지에 FAQ 키워드가 포함되면 매칭

### 1-1. FAQ 대용량(100행+) 대응 레이어
- **전체 조회 방식 종료**: FAQ가 커지면 매 요청마다 FAQ 전체를 읽지 않고, `FAQ_키워드인덱스`에서 후보 faqId만 먼저 조회
- **2단계 매칭**:
  1) 정규화 키워드(띄어쓰기/어미/동의어 통합) 기반 후보 추출
  2) 후보 FAQ에만 점수 계산(키워드 일치 수 + 최근 사용 빈도)
- **핫셋 캐시**: 최근 24시간 자주 조회된 FAQ를 n8n static data(또는 Redis)로 캐시해 API 호출량 절감
- **폴백 규칙**: 후보가 없거나 점수가 낮으면 Tier 2로 즉시 이동

> 권장 임계값: FAQ 150행 이상 또는 일일 질의 300건 이상이면 인덱스 기반 조회를 기본 모드로 전환.

### 1-2. 사용자 경험(UX) 보호 레이어
- **선제 안내 메시지(Immediate Ack)**: 사용자 메시지 수신 직후 `"문의 내용을 확인하고 있습니다. 잠시만 기다려주세요."`를 먼저 전송
- **모호성 해소 재질문(Clarification)**: 의도 분류 confidence가 낮거나 다중 해석 가능 시 바로 답하지 않고 좁히는 질문을 1회 전송
  - 예: `"휴가 일수" 문의 → 연차/경조휴가/병가 중 어떤 휴가를 말씀하실까요?`
- **재질문 횟수 제한**: 같은 세션에서 최대 1회만 재질문 후, 여전히 불명확하면 담당자 안내로 전환
- **효과**: 체감 대기시간 불만 감소 + 오답/헛답변 방지

### 2. 카테고리별 규정 분리 (Tier 2)
- 규정 데이터를 인사/총무/회계 카테고리별 별도 시트로 분리
- 의도 분류 결과에 따라 해당 카테고리 규정만 조회
- 전체 규정을 매번 보내지 않으므로 Gemini context 최소화 → 속도 향상

### 3. Gemini Flash 모델
- `gemini-2.0-flash` 사용 (Pro 대비 5-10배 빠름, 비용 1/10)
- 경영지원 문의 응대 수준에서는 Flash로 충분
- 복잡한 판단이 필요한 경우만 Pro 고려 (현재 불필요)

### 4. 멀티턴 컨텍스트 제한
- **동일 세션(sessionId)의 대화만 조회**: 사용자 전체 과거 이력은 참조하지 않음
- **권장 세션 타임아웃: 20분** (후속 질문 문맥 유지와 오기억 방지의 균형점)
- 조회 범위는 `sessionId + 최근 6턴(사용자/봇 합)`으로 제한
- 20분 초과 시 새 세션 발급 후 문맥 초기화

## 정확도 최적화 설계

### 1. 규정 기반 강제 (Grounding)
- 시스템 프롬프트에 "제공된 규정에만 기반하여 답변" 명시
- 규정에 없는 내용 → "해당 내용은 규정에서 확인되지 않습니다" + 에스컬레이션

### 2. 출처 명시
- 모든 답변에 근거 규정 표시: "근거: 연차휴가 규정 제5조"
- 사용자가 답변의 신뢰성을 직접 확인 가능

### 3. 신뢰도 기반 에스컬레이션
- Gemini 응답에 confidence 필드 포함 요청
- confidence < 0.7 → 답변과 함께 "정확한 확인이 필요하시면 담당자에게 문의해주세요" 병기
- confidence < 0.4 → 답변 미제공, 바로 에스컬레이션

### 4. FAQ 우선 전략
- 검증된 FAQ 답변이 있으면 Gemini 생성 답변보다 우선
- FAQ 테이블은 경영지원팀이 직접 관리 → 정확도 보장

### 5. 피드백 루프
- 에스컬레이션된 질문을 주기적으로 검토
- 반복되는 에스컬레이션 → FAQ에 추가
- 오답 제보 → FAQ/규정 데이터 수정

### 6. 확장 단계별 FAQ 검색 전략

| 단계 | FAQ 규모 | 검색 전략 | 비고 |
|------|----------|----------|------|
| Stage A | ~100행 | 단순 키워드 매칭 | MVP/파일럿 |
| Stage B | 100~500행 | 키워드 인덱스 + 후보군 스코어링 | 기본 운영 권장 |
| Stage C | 500행+ | Vector DB(예: pgvector) + 하이브리드 검색 | 정확도/속도 동시 확보 |

Stage C로 전환해도 Tier 구조(FAQ 우선 → 규정 생성 → 에스컬레이션)는 동일하게 유지한다.

## 네이버웍스 봇 인증 흐름

```
[n8n]
  ↓ 1. JWT 생성 (Service Account + Private Key)
[NAVER WORKS Auth API]
  ↓ 2. Access Token 발급 (유효기간: 24시간)
[n8n]
  ↓ 3. Access Token으로 Bot API 호출
[NAVER WORKS Bot API]
```

### 인증 정보 필요 목록
- Client ID / Client Secret (Developer Console)
- Service Account ID
- Private Key (RSA)
- Bot ID

### API 엔드포인트
| 용도 | Method | URL |
|------|--------|-----|
| 토큰 발급 | POST | `https://auth.worksmobile.com/oauth2/v2.0/token` |
| 메시지 전송 | POST | `https://www.worksapis.com/v1.0/bots/{botId}/users/{userId}/messages` |
| 메시지 수신 | - | Webhook Callback URL (n8n Webhook 주소 등록) |

## 컴포넌트 다이어그램

```
┌─────────────────────────────────────────────────┐
│                   n8n Server                     │
│                                                  │
│  ┌──────────────┐    ┌────────────────────────┐ │
│  │ Sub-workflow  │    │    Main Workflow        │ │
│  │ 네이버웍스 인증│    │                        │ │
│  │              │    │  Webhook                │ │
│  │ JWT 생성     │    │    ↓                    │ │
│  │    ↓         │◄───│  메시지 파싱             │ │
│  │ 토큰 발급    │    │    ↓                    │ │
│  │    ↓         │───►│  대화 이력 조회          │ │
│  │ 토큰 캐시    │    │    ↓                    │ │
│  └──────────────┘    │  FAQ 매칭 ──► 즉시응답   │ │
│                      │    ↓ (미매칭)            │ │
│                      │  의도 분류 (Gemini)      │ │
│                      │    ↓                    │ │
│                      │  규정 조회               │ │
│                      │    ↓                    │ │
│                      │  응답 생성 (Gemini)      │ │
│                      │    ↓                    │ │
│                      │  대화 이력 저장           │ │
│                      │    ↓                    │ │
│                      │  응답 전송               │ │
│                      └────────────────────────┘ │
│                                                  │
│  ┌──────────────────────────────────────────┐   │
│  │          Google Sheets (4개 시트)          │   │
│  │  FAQ │ 규정(인사/총무/회계) │ 담당자 │ 이력  │   │
│  └──────────────────────────────────────────┘   │
│                                                  │
│  ┌──────────────────────────────────────────┐   │
│  │          Gemini API (Flash)               │   │
│  │  의도 분류 / 응답 생성                      │   │
│  └──────────────────────────────────────────┘   │
└─────────────────────────────────────────────────┘
```
