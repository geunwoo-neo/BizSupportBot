# 시스템 아키텍처

## 전체 흐름

```
[임직원]
   ↓ 메시지 전송
[네이버웍스 1:1 봇]
   ↓ Callback (Webhook)
[n8n 메인 워크플로우]
   ├─→ [대화 이력 조회]        ← Google Sheets (대화이력)
   ├─→ [FAQ 캐시 매칭]         ← Google Sheets (FAQ)
   │     ├─ 매칭됨 → 즉시 응답 (Gemini 호출 X)
   │     └─ 미매칭 ↓
   ├─→ [의도 분류 - Gemini]    → category, isAnswerable
   │     ├─ 답변 가능 ↓
   │     └─ 답변 불가 → 에스컬레이션 안내
   ├─→ [규정 조회]             ← Google Sheets (카테고리별 규정)
   ├─→ [응답 생성 - Gemini]    → 규정 기반 답변
   ├─→ [대화 이력 저장]        → Google Sheets (대화이력)
   └─→ [네이버웍스 응답 전송]
```

## 3-Tier 응답 전략

속도와 정확도를 동시에 잡기 위한 계층형 응답 구조.

| Tier | 조건 | 처리 방식 | 예상 응답 시간 |
|------|------|----------|--------------|
| **Tier 1** | FAQ 정확 매칭 | 사전 검증된 답변 즉시 반환 | ~1초 |
| **Tier 2** | FAQ 미매칭 + 답변 가능 | Gemini로 규정 기반 응답 생성 | ~3-5초 |
| **Tier 3** | 답변 불가 판단 | 담당자 정보 안내 (에스컬레이션) | ~2초 |

### Tier 1이 중요한 이유

- 임직원 문의의 60-70%는 반복 질문 (연차 며칠? 법인카드 한도? 출장비 정산 기한?)
- FAQ 매칭으로 Gemini 호출 없이 즉시 응답 → **비용 절감 + 속도 향상 + 정확도 보장**
- FAQ 답변은 경영지원 담당자가 직접 검수한 내용 → 할루시네이션 위험 0

## 속도 최적화 설계

### 1. FAQ 캐시 레이어 (Tier 1)
- Google Sheets에 자주 묻는 질문+답변 매핑 테이블 운영
- 키워드 기반 매칭으로 Gemini API 호출 자체를 스킵
- 매칭 로직: 사용자 메시지에 FAQ 키워드가 포함되면 매칭

### 2. 카테고리별 규정 분리 (Tier 2)
- 규정 데이터를 인사/총무/회계 카테고리별 별도 시트로 분리
- 의도 분류 결과에 따라 해당 카테고리 규정만 조회
- 전체 규정을 매번 보내지 않으므로 Gemini context 최소화 → 속도 향상

### 3. Gemini Flash 모델
- `gemini-2.0-flash` 사용 (Pro 대비 5-10배 빠름, 비용 1/10)
- 경영지원 문의 응대 수준에서는 Flash로 충분
- 복잡한 판단이 필요한 경우만 Pro 고려 (현재 불필요)

### 4. 멀티턴 컨텍스트 제한
- 대화 이력은 최근 5건 + 30분 이내만 조회
- 오래된 대화는 새 세션으로 취급 → 불필요한 context 누적 방지

## 정확도 최적화 설계

### 1. 규정 기반 강제 (Grounding)
- 시스템 프롬프트에 "제공된 규정에만 기반하여 답변" 명시
- 규정에 없는 내용 → "해당 내용은 규정에서 확인되지 않습니다" + 에스컬레이션

### 2. 출처 명시
- 모든 답변에 근거 규정 표시: "근거: 연차휴가 규정 제5조"
- 사용자가 답변의 신뢰성을 직접 확인 가능

### 3. 신뢰도 기반 에스컬레이션
- Gemini 응답에 confidence 필드 포함 요청
- confidence < 0.7 → 답변과 함께 "정확한 확인이 필요하시면 담당자에게 문의해주세요" 병기
- confidence < 0.4 → 답변 미제공, 바로 에스컬레이션

### 4. FAQ 우선 전략
- 검증된 FAQ 답변이 있으면 Gemini 생성 답변보다 우선
- FAQ 테이블은 경영지원팀이 직접 관리 → 정확도 보장

### 5. 피드백 루프
- 에스컬레이션된 질문을 주기적으로 검토
- 반복되는 에스컬레이션 → FAQ에 추가
- 오답 제보 → FAQ/규정 데이터 수정

## 네이버웍스 봇 인증 흐름

```
[n8n]
  ↓ 1. JWT 생성 (Service Account + Private Key)
[NAVER WORKS Auth API]
  ↓ 2. Access Token 발급 (유효기간: 24시간)
[n8n]
  ↓ 3. Access Token으로 Bot API 호출
[NAVER WORKS Bot API]
```

### 인증 정보 필요 목록
- Client ID / Client Secret (Developer Console)
- Service Account ID
- Private Key (RSA)
- Bot ID

### API 엔드포인트
| 용도 | Method | URL |
|------|--------|-----|
| 토큰 발급 | POST | `https://auth.worksmobile.com/oauth2/v2.0/token` |
| 메시지 전송 | POST | `https://www.worksapis.com/v1.0/bots/{botId}/users/{userId}/messages` |
| 메시지 수신 | - | Webhook Callback URL (n8n Webhook 주소 등록) |

## 컴포넌트 다이어그램

```
┌─────────────────────────────────────────────────┐
│                   n8n Server                     │
│                                                  │
│  ┌──────────────┐    ┌────────────────────────┐ │
│  │ Sub-workflow  │    │    Main Workflow        │ │
│  │ 네이버웍스 인증│    │                        │ │
│  │              │    │  Webhook                │ │
│  │ JWT 생성     │    │    ↓                    │ │
│  │    ↓         │◄───│  메시지 파싱             │ │
│  │ 토큰 발급    │    │    ↓                    │ │
│  │    ↓         │───►│  대화 이력 조회          │ │
│  │ 토큰 캐시    │    │    ↓                    │ │
│  └──────────────┘    │  FAQ 매칭 ──► 즉시응답   │ │
│                      │    ↓ (미매칭)            │ │
│                      │  의도 분류 (Gemini)      │ │
│                      │    ↓                    │ │
│                      │  규정 조회               │ │
│                      │    ↓                    │ │
│                      │  응답 생성 (Gemini)      │ │
│                      │    ↓                    │ │
│                      │  대화 이력 저장           │ │
│                      │    ↓                    │ │
│                      │  응답 전송               │ │
│                      └────────────────────────┘ │
│                                                  │
│  ┌──────────────────────────────────────────┐   │
│  │          Google Sheets (4개 시트)          │   │
│  │  FAQ │ 규정(인사/총무/회계) │ 담당자 │ 이력  │   │
│  └──────────────────────────────────────────┘   │
│                                                  │
│  ┌──────────────────────────────────────────┐   │
│  │          Gemini API (Flash)               │   │
│  │  의도 분류 / 응답 생성                      │   │
│  └──────────────────────────────────────────┘   │
└─────────────────────────────────────────────────┘
```
