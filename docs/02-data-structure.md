# 데이터 구조 설계

## 개요

모든 데이터는 Google Sheets에 저장한다. 하나의 스프레드시트 파일 안에 시트(탭)를 분리하여 관리.
규정량이 많아지면 Confluence/Google Docs 연동을 2차로 추가한다.

## 스프레드시트 구조

```
[BizSupportBot_Data] (Google Sheets 파일 1개)
├── 시트: FAQ                  ← 경영지원 실무자 편집
├── 시트: 규정_인사             ← 경영지원 실무자 편집
├── 시트: 규정_총무             ← 경영지원 실무자 편집
├── 시트: 규정_회계             ← 경영지원 실무자 편집
├── 시트: 담당자                ← 경영지원 실무자 편집
├── 시트: 대화이력              ← 봇 전용 (자동 기록)
├── 시트: 운영로그              ← 봇 전용 (성과 측정용)
├── 시트: 대시보드_일간          ← 자동 집계 (수식/차트)
└── 시트: 대시보드_월간          ← 자동 집계 (수식/차트)
```

> 시트별 권한 설계는 `06-operations-governance.md` 참조

---

## 시트 1: FAQ

자주 묻는 질문과 검증된 답변. Tier 1 즉시 응답에 사용.
대용량 운영을 위해 FAQ 본문과 검색 인덱스를 분리해 관리한다.

| 컬럼 | 타입 | 설명 | 예시 |
|------|------|------|------|
| faqId | string | 고유 ID | FAQ-HR-001 |
| category | string | 대분류 (인사/총무/회계) | 인사 |
| subCategory | string | 소분류 | 연차휴가 |
| keywords | string | 매칭 키워드 (쉼표 구분) | 연차,남은연차,잔여연차,휴가일수 |
| question | string | 대표 질문 | 연차 남은 일수를 어떻게 확인하나요? |
| answer | string | 검증된 답변 | 네이버웍스 > 근태관리 > 잔여휴가에서 확인 가능합니다. |
| source | string | 근거 규정 | 연차휴가 규정 제3조 |
| isActive | boolean | 활성 여부 | TRUE |
| lastUpdated | date | 최종 수정일 | 2026-02-19 |

### FAQ 작성 가이드
- **keywords**: 사용자가 실제로 사용할 단어를 다양하게 등록 (구어체 포함)
- **answer**: 구체적이고 실행 가능한 답변 (경로, 기한, 금액 등 명시)
- **category별 최소 10-20개**로 시작, 운영하면서 확대

## 시트 1-보조: FAQ_키워드인덱스 (신규)

FAQ 대량화 시 검색 성능을 위한 역인덱스 시트. 한 행 = 키워드 1개.

| 컬럼 | 타입 | 설명 | 예시 |
|------|------|------|------|
| keyword | string | 정규화 키워드 | 연차 |
| faqIds | string | 매칭 FAQ ID 목록(`,` 구분) | FAQ-HR-001,FAQ-HR-013 |
| weight | number | 키워드 중요도(1~5) | 4 |
| synonyms | string | 동의어/표현 변형(`,` 구분) | 휴가,연차휴가,연차사용 |
| lastUpdated | date | 최종 수정일 | 2026-02-19 |

### 인덱스 운영 규칙
- FAQ 150행 이상이면 `fetchFAQ` 전량 조회 대신 **인덱스 우선 조회**를 기본으로 사용
- 새로운 FAQ 추가 시 keywords를 인덱스에도 반영 (주 1회 점검)
- 동일 keyword에 FAQ가 20개 이상 연결되면 keyword를 세분화

---

## 시트 2-4: 규정_인사 / 규정_총무 / 규정_회계

Gemini가 참조할 규정 데이터. 카테고리별 별도 시트.

| 컬럼 | 타입 | 설명 | 예시 |
|------|------|------|------|
| regulationId | string | 고유 ID | REG-HR-001 |
| title | string | 규정 제목 | 연차휴가 사용 규정 |
| section | string | 조항 번호 | 제5조 |
| content | string | 규정 내용 (본문) | 연차휴가는 입사일 기준으로... |
| summary | string | 요약 (1-2줄) | 연차 부여 기준 및 사용 방법 |
| effectiveDate | date | 시행일 | 2025-01-01 |
| sourceUrl | string | 원문 링크 (Confluence 등) | https://confluence.xxx.com/... |
| tags | string | 검색 태그 (쉼표 구분) | 연차,휴가,부여,사용 |
| lastUpdated | date | 최종 수정일 | 2026-02-01 |

### 규정 데이터 입력 가이드

**이미 디지털화된 규정:**
1. Confluence/Google Docs에서 내용 복사
2. 조항 단위로 행 분리 (한 행 = 한 조항)
3. sourceUrl에 원문 링크 기록

**신규 디지털화 규정:**
1. PDF/한글 파일에서 조항별 텍스트 추출
2. 동일한 구조로 시트에 입력
3. 원문 파일은 Google Drive에 업로드 후 링크 연결

### content 작성 규칙
- **한 행에 한 조항**: "제5조 (연차휴가 부여) 1. 입사 1년 미만 직원은..."
- **너무 길지 않게**: 조항 하나가 500자를 넘으면 항목별로 행을 분리
- **핵심 수치 명시**: 금액, 기간, 기한 등은 반드시 포함

---

## 시트 5: 담당자

에스컬레이션 시 안내할 담당자 정보.

| 컬럼 | 타입 | 설명 | 예시 |
|------|------|------|------|
| category | string | 대분류 | 인사 |
| subCategory | string | 소분류 | 연차휴가 |
| team | string | 담당팀 | 인사팀 |
| name | string | 담당자명 | 홍길동 |
| contact | string | 연락처 (내선/메신저) | 내선 1234 |
| email | string | 이메일 | hong@company.com |
| note | string | 비고 | 오전에 연락 선호 |

### 에스컬레이션 안내 메시지 포맷

```
죄송합니다. 해당 문의는 정확한 확인이 필요한 사항입니다.

📋 담당 부서: {team}
👤 담당자: {name}
📞 연락처: {contact}

위 담당자에게 직접 문의해주시면 빠르게 안내받으실 수 있습니다.
```

---

## 시트 6: 대화이력

멀티턴 대화를 위한 대화 로그.

| 컬럼 | 타입 | 설명 | 예시 |
|------|------|------|------|
| sessionId | string | 세션 ID (userId + 시작시각 해시) | user123_20260219T1430 |
| userId | string | 네이버웍스 사용자 ID | user123 |
| timestamp | datetime | 메시지 시각 | 2026-02-19 14:30:00 |
| role | string | 발화자 (user / bot) | user |
| message | string | 메시지 내용 | 연차 며칠 남았어? |
| category | string | 분류된 카테고리 | 인사 |
| tier | string | 응답 Tier (1/2/3) | 1 |
| isEscalated | boolean | 에스컬레이션 여부 | FALSE |

### 멀티턴 대화 이력 관리 규칙

- **조회 범위**: 동일 `sessionId`의 최근 6턴(예: 사용자 3 + 봇 3)
- **권장 세션 타임아웃**: 마지막 사용자 메시지 기준 20분
- **20분 초과** 시 새 세션으로 취급 (`sessionId` 갱신), 기존 세션 문맥 미참조
- **이력 정리**: 7일 이상 지난 이력은 월 1회 아카이빙 (별도 시트 이동)
- **용도**: Gemini 호출 시 해당 세션 `conversationHistory`만 전달

---

## 데이터 볼륨 예상 및 확장 전략

### MVP 기준 예상 볼륨

| 시트 | 예상 행 수 | 비고 |
|------|-----------|------|
| FAQ | 100-500행 | 운영 3개월 이후 누적 반영 |
| FAQ_키워드인덱스 | 300-2,000행 | FAQ 1건당 키워드 3-6개 기준 |
| 규정 (3개 시트 합계) | 100-300행 | 조항 단위 분리 시 |
| 담당자 | 10-20행 | 소분류별 1명 |
| 대화이력 | 일 50-200행 | 사용량에 따라 변동 |

### Google Sheets 한계 및 대응

| 한계 | 임계점 | 대응 방안 |
|------|--------|----------|
| 규정 데이터 과다 | 규정 1,000행 이상 | Confluence API 연동으로 전환 (2차) |
| 대화이력 누적 | 10,000행 이상 | 월별 아카이빙 + 오래된 데이터 삭제 |
| API 호출 제한 | 분당 60회 | 인덱스 조회 + 핫셋 캐시 + 배치 동기화 |

### 2차 확장: Confluence 연동

규정량이 Google Sheets 한 시트에 담기 어려울 때:
1. Confluence에 규정 원문 저장 (카테고리별 Space/Page)
2. n8n에서 Confluence REST API로 검색
3. FAQ는 Google Sheets 유지 + FAQ_키워드인덱스 동시 운영
4. FAQ 500행 이상이면 벡터 검색 계층(pgvector 등) 추가 검토
